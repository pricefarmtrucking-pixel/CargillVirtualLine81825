<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Facility — Appointments</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .container { max-width: 1200px; margin: 5vh auto; padding: 0 1rem; }
    .card { border:1px solid #ddd; border-radius:12px; padding:1rem; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.03); }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .button { padding:.48rem .8rem; border-radius:10px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
    .button.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }
    .input, .select { padding:.48rem .6rem; border:1px solid #ccc; border-radius:10px; }
    table { width:100%; border-collapse: collapse; margin-top:.75rem; }
    th, td { padding:.52rem .6rem; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th.sticky { position: sticky; top:0; background:#fff; z-index:1; }
    .mono { font-variant-numeric: tabular-nums; letter-spacing:.02em; }
    .tag { font-size:.83rem; padding:.15rem .5rem; border-radius:999px; border:1px solid #ddd; background:#fafafa; white-space:nowrap; }
    .tag.ok { background:#e9f7ef; border-color:#bfe5cf; color:#0a7a28; }
    .muted { color:#666; }
    .right { margin-left:auto; }
    .err { color:#b00020; }
    .ok { color:#0a7a28; }
    .toolbar { gap:.8rem; }
    .chip { padding:.15rem .5rem; border:1px solid #e5e5e5; border-radius:999px; background:#fafafa; font-size:.85rem; }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row toolbar" style="margin-bottom:.4rem;">
      <strong>Facility — Appointments</strong>
      <span id="env" class="chip"></span>
      <span class="right"></span>
      <a class="button" href="index.html">Home</a>
      <button id="btnRefresh" class="button">Refresh</button>
      <label class="row" style="gap:.35rem;">
        <input id="auto" type="checkbox"/>
        <span class="muted">Auto‑refresh (30s)</span>
      </label>
    </div>

    <div class="row" style="margin-bottom:.3rem;">
      <label>Site
        <select id="site" class="select">
          <option value="1">East</option>
          <option value="2">West</option>
        </select>
      </label>
      <label>Date
        <input id="date" class="input" type="date"/>
      </label>

      <span class="right"></span>

      <label>Filter
        <select id="filter" class="select">
          <option value="all">All</option>
          <option value="open">Open</option>
          <option value="reserved">Reserved</option>
        </select>
      </label>
      <label>Search
        <input id="search" class="input" placeholder="Name, plate, vendor, code, phone…"/>
      </label>
    </div>

    <div id="status" class="muted" style="min-height:1.2em; margin:.2rem 0 .4rem;"></div>

    <div style="overflow:auto; max-height:68vh; border:1px solid #eee; border-radius:10px;">
      <table id="grid">
        <thead>
          <tr>
            <th class="sticky">Time</th>
            <th class="sticky">Driver</th>
            <th class="sticky">Plate</th>
            <th class="sticky">Vendor</th>
            <th class="sticky">Farm/Ticket</th>
            <th class="sticky">Est. Amt</th>
            <th class="sticky">Unit</th>
            <th class="sticky">Phone</th>
            <th class="sticky">Probe Code</th>
            <th class="sticky">Status</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== Config / helpers =====
  const API = ''; // same-origin
  const $ = id => document.getElementById(id);
  const todayISO = ()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10);};
  const esc = s => String(s ?? '').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const siteName = id => (Number(id)===2?'West':'East');

  let autoTimer = null;
  const state = { site:1, date: todayISO(), rows:[], slots:[], appointments:[], lastFetchMsg:'' };

  // Preset controls
  $('date').value = state.date;
  $('site').value = String(state.site);

  // Env chip (helps debug CORS/deploys)
  const origin = location.origin;
  $('env').textContent = origin;

  // Bind UI
  $('btnRefresh').addEventListener('click', ()=> refresh(true));
  $('auto').addEventListener('change', ()=> toggleAuto($('auto').checked));
  $('site').addEventListener('change', ()=>{ state.site = Number($('site').value); refresh(true); });
  $('date').addEventListener('change', ()=>{ state.date = $('date').value || todayISO(); refresh(true); });
  $('filter').addEventListener('change', render);
  $('search').addEventListener('input', render);

  // First load
  refresh(true);

  function toggleAuto(on){
    clearInterval(autoTimer);
    if (on) autoTimer = setInterval(()=> refresh(false), 30000);
  }

  async function refresh(showStatus){
    setStatus(showStatus ? 'Loading…' : '');
    $('tbody').innerHTML = `<tr><td colspan="10" class="muted">Loading…</td></tr>`;
    const qs = `site=${encodeURIComponent(state.site)}&date=${encodeURIComponent(state.date)}`;

    try{
      const [slotsR, apptsR] = await Promise.all([
        fetch(`${API}/api/slots?${qs}`, { credentials:'include' }),
        fetch(`${API}/api/appointments?${qs}`, { credentials:'include' })
      ]);

      // Handle auth errors
      if (slotsR.status === 401 || apptsR.status === 401) {
        setStatus('Not signed in. Redirecting to Probe login…', 'err');
        setTimeout(()=> location.href = 'probe-login.html', 800);
        return;
      }

      // Handle CORS/network issues
      if (!slotsR.ok) {
        const t = await safeText(slotsR);
        throw new Error(`/api/slots ${slotsR.status} ${slotsR.statusText} ${t||''}`);
      }
      if (!apptsR.ok) {
        const t = await safeText(apptsR);
        throw new Error(`/api/appointments ${apptsR.status} ${apptsR.statusText} ${t||''}`);
      }

      const slotsJ = await safeJson(slotsR);
      const apptsJ = await safeJson(apptsR);

      // Expect { ok:true, slots:[...] } and { ok:true, appointments:[...] }
      const slots = (slotsJ && slotsJ.slots) ? slotsJ.slots : [];
      const appointments = (apptsJ && (apptsJ.appointments || apptsJ.items)) ? (apptsJ.appointments || apptsJ.items) : [];

      state.slots = slots;
      state.appointments = appointments;
      state.rows = combine(slots, appointments);

      setStatus(`Showing ${state.rows.length} rows for ${siteName(state.site)} on ${state.date}.`);
      render();
    }catch(err){
      console.error(err);
      setStatus(`Load failed: ${err.message||err}`, 'err');
      $('tbody').innerHTML = `<tr><td colspan="10" class="err">Error loading data. Check Console (DevTools) for details.</td></tr>`;
    }
  }

  function setStatus(msg, kind){
    const el = $('status');
    el.textContent = msg || '';
    el.classList.remove('err','ok');
    if (kind) el.classList.add(kind);
  }

  async function safeJson(res){
    try { return await res.json(); } catch { return null; }
  }
  async function safeText(res){
    try { return await res.text(); } catch { return ''; }
  }

  // Merge time base (slots) with reservation details (appointments)
  function combine(slots, appts){
    const map = new Map();
    (appts||[]).forEach(r=>{
      // normalize keys from either structure
      const time = r.time || r.slot_time;
      map.set(time, {
        time,
        status: (r.status || '').toLowerCase()==='reserved' ? 'Reserved' : 'Reserved',
        driver: r.driver || r.driver_name || '',
        plate: r.plate || r.license_plate || '',
        vendor: r.vendor || r.vendor_name || '',
        farm_ticket: r.farm_ticket || r.farm_or_ticket || '',
        est_amt: r.est_amount ?? r.est_amt ?? '',
        est_unit: r.est_unit || '',
        phone: r.phone || r.driver_phone || '',
        probe_code: r.probe_code || r.queue_code || ''
      });
    });

    const rows = [];
    (slots||[]).forEach(s=>{
      const time = s.slot_time || s.time;
      const r = map.get(time);
      if (r) {
        rows.push(r);
      } else {
        rows.push({
          time,
          status: (s.is_reserved? 'Reserved' : 'Open'),
          driver:'', plate:'', vendor:'', farm_ticket:'',
          est_amt:'', est_unit:'', phone:'', probe_code:''
        });
      }
    });

    // In the unlikely case there were reservations without a slot row:
    (appts||[]).forEach(r=>{
      const time = r.time || r.slot_time;
      if (!rows.find(x=>x.time===time)) {
        rows.push({
          time,
          status:'Reserved',
          driver: r.driver || r.driver_name || '',
          plate: r.plate || r.license_plate || '',
          vendor: r.vendor || r.vendor_name || '',
          farm_ticket: r.farm_ticket || r.farm_or_ticket || '',
          est_amt: r.est_amount ?? r.est_amt ?? '',
          est_unit: r.est_unit || '',
          phone: r.phone || r.driver_phone || '',
          probe_code: r.probe_code || r.queue_code || ''
        });
      }
    });

    return rows.sort((a,b)=> String(a.time).localeCompare(String(b.time)));
  }

  function render(){
    const f = $('filter').value;
    const q = $('search').value.trim().toLowerCase();

    const rows = state.rows.filter(r=>{
      if (f==='open' && r.status==='Reserved') return false;
      if (f==='reserved' && r.status!=='Reserved') return false;
      if (!q) return true;
      const bag = [r.time,r.driver,r.plate,r.vendor,r.farm_ticket,r.phone,r.probe_code].join(' ').toLowerCase();
      return bag.includes(q);
    });

    $('tbody').innerHTML = rows.length ? rows.map(tr).join('') :
      `<tr><td colspan="10" class="muted">No rows match.</td></tr>`;
  }

  function tr(r){
    const badge = r.status==='Reserved'
      ? `<span class="tag ok">Reserved</span>`
      : `<span class="tag">Open</span>`;
    return `<tr>
      <td class="mono">${esc(r.time||'')}</td>
      <td>${esc(r.driver||'—')}</td>
      <td class="mono">${esc(r.plate||'—')}</td>
      <td>${esc(r.vendor||'—')}</td>
      <td>${esc(r.farm_ticket||'—')}</td>
      <td>${esc(r.est_amt||'—')}</td>
      <td>${esc(r.est_unit||'—')}</td>
      <td>${esc(r.phone||'—')}</td>
      <td class="mono">${esc(r.probe_code||'—')}</td>
      <td>${badge}</td>
    </tr>`;
  }
})();
</script>
</body>
</html>
