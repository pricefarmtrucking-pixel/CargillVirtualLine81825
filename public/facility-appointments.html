<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cargill Soybean — Facility Appointments</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .container { max-width: 1200px; margin: 5vh auto; padding: 0 1rem; }
    .card { border:1px solid #ddd; border-radius:12px; padding:1rem; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.03); }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .button { padding:.45rem .8rem; border:1px solid #ddd; border-radius:10px; background:#f7f7f7; cursor:pointer; }
    .button.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }
    .select, .input { padding:.45rem .6rem; border:1px solid #ccc; border-radius:10px; }
    table { width:100%; border-collapse:collapse; margin-top:.75rem; }
    th, td { padding:.5rem .6rem; border-bottom:1px solid #eee; text-align:left; }
    th.sticky { position:sticky; top:0; background:#fff; z-index:1; }
    .mono { font-variant-numeric: tabular-nums; }
    .tag { font-size:.83rem; padding:.15rem .5rem; border-radius:999px; border:1px solid #ddd; background:#fafafa; }
    .tag.ok { background:#e9f7ef; border-color:#bfe5cf; color:#0a7a28; }
    .muted { color:#666; }
    .right { margin-left:auto; }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="margin-bottom:.5rem;">
      <strong>Cargill Soybean — Facility</strong>
      <div class="right"></div>
      <!-- Schedule Builder button was removed per your request -->
      <a class="button" href="index.html">Driver Site</a>
    </div>

    <h2 style="margin:.2rem 0;">Appointments — <span id="hdr"></span></h2>

    <div class="row">
      <label>Site
        <select id="site" class="select">
          <option value="1">East</option>
          <option value="2">West</option>
        </select>
      </label>

      <label>Date
        <input id="date" class="input" type="date"/>
      </label>

      <button id="btnRefresh" class="button">Refresh</button>

      <div class="right row">
        <label>Filter
          <select id="filter" class="select">
            <option value="all">All</option>
            <option value="open">Open</option>
            <option value="reserved">Reserved</option>
            <option value="workin">Work‑in</option>
          </select>
        </label>

        <label>Search
          <input id="search" class="input" placeholder="Name, plate, code…"/>
        </label>
      </div>
    </div>

    <div id="note" class="muted" style="margin-top:.5rem;"></div>

    <table id="grid">
      <thead>
        <tr>
          <th class="sticky">Time</th>
          <th class="sticky">Driver</th>
          <th class="sticky">Plate</th>
          <th class="sticky">Vendor</th>
          <th class="sticky">Status</th>
          <th class="sticky">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const api = ''; // same origin
  const isoToday = ()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10);};
  const hhmm = (s)=>s; // times already "HH:MM"

  // --- State
  const state = { site_id: 1, date: isoToday(), slots: [], reservations: [] };

  // --- UI init
  $('date').value = state.date;
  $('site').value = String(state.site_id);

  $('btnRefresh').addEventListener('click', refresh);
  $('site').addEventListener('change', ()=>{ state.site_id = Number($('site').value); refresh(); });
  $('date').addEventListener('change', ()=>{ state.date = $('date').value || isoToday(); refresh(); });
  $('filter').addEventListener('change', render);
  $('search').addEventListener('input', render);

  refresh(); // first load

  // --- Fetch & merge
  async function refresh(){
    $('tbody').innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;
    $('hdr').textContent = `${state.date} (${state.site_id===2?'West':'East'})`;

    try{
      const [slotsRes, resvRes] = await Promise.all([
        fetch(`${api}/api/sites/${state.site_id}/slots?date=${encodeURIComponent(state.date)}&include_all=1`, { credentials:'include' }),
        fetch(`${api}/api/appointments?site_id=${state.site_id}&date=${encodeURIComponent(state.date)}`, { credentials:'include' })
      ]);

      // /api/sites/:id/slots now asked with include_all=1 so the server can (optionally) return all slots, not only open.
      // If your current server ignores include_all, we’ll build the full timeline from reservations when no slots are returned.

      const slotsPayload = await slotsRes.json().catch(()=>[]);
      const reservations = await resvRes.json().catch(()=>[]);

      // Normalize: slotsPayload can be either array of times or array of {slot_time,is_workin}
      let slotTimes = [];
      if (Array.isArray(slotsPayload)) {
        if (slotsPayload.length && typeof slotsPayload[0]==='object' && slotsPayload[0].slot_time){
          slotTimes = slotsPayload.map(s=>({ time:s.slot_time, is_workin: !!s.is_workin }));
        } else {
          slotTimes = slotsPayload.map(t=>({ time:t, is_workin:false }));
        }
      }

      // If server only returns open slots (default), we still want a timeline that shows reserved rows.
      // Build a set from reservations and union with slots.
      const resvByTime = {};
      for (const r of reservations) {
        resvByTime[r.slot_time] = r;
        if (!slotTimes.find(s=>s.time===r.slot_time)) {
          slotTimes.push({ time:r.slot_time, is_workin:false });
        }
      }

      // Sort ascending by time
      slotTimes.sort((a,b)=>a.time.localeCompare(b.time));

      state.slots = slotTimes;
      state.reservations = reservations;
      $('note').textContent = slotTimes.length ? '' : 'No schedule found for this date/site.';

      render();
    }catch(e){
      $('tbody').innerHTML = `<tr><td colspan="6" style="color:#b00020;">Failed to load: ${(e&&e.message)||e}</td></tr>`;
    }
  }

  function render(){
    const q = $('search').value.trim().toLowerCase();
    const mode = $('filter').value;

    // Build a quick lookup for reservations by time
    const byTime = {};
    for (const r of state.reservations) byTime[r.slot_time] = r;

    const rows = [];
    for (const s of state.slots) {
      const r = byTime[s.time];
      const status = r ? 'Reserved' : 'Open';
      const driver = r?.driver_name || '';
      const plate  = r?.license_plate || '';
      const vendor = r?.vendor_name || '';
      const text = [s.time, driver, plate, vendor, r?.queue_code].join(' ').toLowerCase();

      if (mode==='open' && r) continue;
      if (mode==='reserved' && !r) continue;
      if (mode==='workin' && !s.is_workin) continue;
      if (q && !text.includes(q)) continue;

      rows.push(rowHtml(s.time, s.is_workin, r));
    }

    $('tbody').innerHTML = rows.length ? rows.join('') :
      `<tr><td colspan="6" class="muted">No rows match.</td></tr>`;
  }

  function rowHtml(time, is_workin, r){
    const tag = is_workin ? `<span class="tag">Work‑in</span>` : '';
    const status = r ? `<span class="tag ok">Reserved</span>` : `<span class="tag">Open</span>`;
    const driver = r ? esc(r.driver_name || '') : '—';
    const plate  = r ? esc(r.license_plate || '') : '—';
    const vendor = r ? esc(r.vendor_name || '') : '—';

    const act = r
      ? `<button class="button" data-act="reassign" data-id="${r.id}">Reassign</button>
         <button class="button" data-act="cancel" data-id="${r.id}">Cancel</button>`
      : `<button class="button" data-act="assign" data-time="${time}">Assign</button>`;

    return `<tr>
      <td class="mono">${hhmm(time)} ${tag}</td>
      <td>${driver}</td>
      <td class="mono">${plate}</td>
      <td>${vendor}</td>
      <td>${status}</td>
      <td>${act}</td>
    </tr>`;
  }

  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // (Optional) wire up future actions; leave as no‑ops for now so UI renders.
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    if (act==='assign') {
      alert(`Assign flow would open dialog to collect driver + POST /api/slots/confirm for ${btn.dataset.time}`);
    } else if (act==='cancel') {
      alert(`Cancel flow would POST /api/slots/cancel { reservation_id: ${btn.dataset.id} }`);
    } else if (act==='reassign') {
      alert(`Reassign flow would POST /api/slots/reassign { reservation_id: ${btn.dataset.id}, to_slot_time }`);
    }
  });
})();
</script>
</body>
</html>
