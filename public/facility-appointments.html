<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Facility Appointments</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .wrap { max-width:1100px; margin: 2rem auto; padding: 0 1rem; }
    h1 { margin:.2rem 0 1rem; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.75rem; align-items:flex-end; margin-bottom:1rem; }
    .toolbar .group { display:flex; gap:.5rem; align-items:center; }
    label { font-size:.9rem; color:#555; }
    input, select, button { padding:.5rem .6rem; border:1px solid #ccc; border-radius:8px; }
    button { cursor:pointer; }
    button.primary { background:#1e90ff; color:#fff; border:none; }
    button.danger { background:#b00020; color:#fff; border:none; }
    button.warn   { background:#ff9800; color:#fff; border:none; }
    button.ghost  { background:#f7f7f7; }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:.55rem .6rem; border-bottom:1px solid #eee; font-size:.94rem; }
    th { text-align:left; background:#fafafa; position:sticky; top:0; z-index:1; }
    tr.disabled { opacity:.5; }
    tr.reserved { background: #fffef5; }
    .muted { color:#666; font-size:.9rem; }
    .tag { font-size:.75rem; padding:.15rem .4rem; border-radius:6px; background:#efefef; }
    .tag.green { background:#e6f6ea; color:#0a7a28; }
    .tag.red { background:#fde8e8; color:#b00020; }
    .tag.gray { background:#eee; color:#555; }
    #msg { min-height:1.2em; margin:.4rem 0 .8rem; color:#0a7a28; }
    #msg.err { color:#b00020; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Facility Appointments</h1>

    <div class="toolbar">
      <div class="group">
        <label>Site</label>
        <select id="site">
          <option value="1">EAST (1)</option>
          <option value="2">WEST (2)</option>
        </select>
      </div>
      <div class="group">
        <label>Date</label>
        <input id="date" type="date">
      </div>
      <div class="group">
        <label>Show</label>
        <select id="filterKind">
          <option value="all">All</option>
          <option value="open">Open only</option>
          <option value="reserved">Reserved only</option>
        </select>
      </div>
      <div class="group">
        <label>From</label>
        <input id="fromTime" type="time" value="00:00">
      </div>
      <div class="group">
        <label>To</label>
        <input id="toTime" type="time" value="23:59">
      </div>
      <div class="group">
        <button id="btnRefresh" class="ghost">Refresh</button>
      </div>
    </div>

    <div class="toolbar" style="gap:.5rem;">
      <div class="group">
        <button id="btnSelectAll" class="ghost">Select All</button>
        <button id="btnClearSel" class="ghost">Clear</button>
      </div>
      <div class="group">
        <button id="btnDisable" class="warn">Disable Selected</button>
        <button id="btnEnable" class="ghost">Enable Selected</button>
      </div>
      <div class="group">
        <button id="btnMassCancel" class="danger">Mass Cancel (Reserved)</button>
      </div>
      <div class="group">
        <input id="notifyText" placeholder="Message to drivers…" style="width:260px;">
        <button id="btnMassNotify" class="primary">Mass Notify</button>
      </div>
    </div>

    <div id="msg"></div>

    <table id="grid">
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll"/></th>
          <th>Time</th>
          <th>Status</th>
          <th>Probe Code</th>
          <th>Driver</th>
          <th>Plate</th>
          <th>Vendor</th>
          <th>Ticket/Farm</th>
          <th>Est Qty</th>
          <th>Phone</th>
          <th>Flags</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const tbody = $('#grid tbody');
  const msg = $('#msg');
  let rows = [];
  let selected = new Set(); // keys: `${slot_time}` for open OR `res:<id>` for reserved

  function setMsg(t, isErr=false){ msg.textContent=t||''; msg.className = isErr?'err':''; }
  function hhmmToMin(t){ const [h,m]=t.split(':').map(n=>+n); return h*60+m; }

  async function load() {
    setMsg('');
    const site_id = +$('#site').value;
    const date = $('#date').value;
    if (!date) return setMsg('Pick a date', true);

    const url = `/api/appointments?site_id=${site_id}&date=${encodeURIComponent(date)}`;
    try{
      const r = await fetch(url, { credentials:'include' });
      const j = await r.json();
      if(!r.ok || !j.ok) throw new Error(j.error || r.statusText);
      rows = j.items || [];
      render();
    }catch(e){ setMsg('Load failed: '+(e?.message||e), true); }
  }

  function render() {
    const kind = $('#filterKind').value;
    const fromMin = hhmmToMin($('#fromTime').value || '00:00');
    const toMin   = hhmmToMin($('#toTime').value || '23:59');

    const data = rows.filter(x=>{
      const tmin = hhmmToMin(x.slot_time);
      if (tmin < fromMin || tmin > toMin) return false;
      const isReserved = !!x.reservation_id;
      if (kind === 'open' && isReserved) return false;
      if (kind === 'reserved' && !isReserved) return false;
      return true;
    });

    tbody.innerHTML = '';
    for (const r of data) {
      const isRes = !!r.reservation_id;
      const tr = document.createElement('tr');
      tr.classList.toggle('reserved', isRes);
      tr.classList.toggle('disabled', !!r.disabled);

      const key = isRes ? `res:${r.reservation_id}` : r.slot_time;

      const tdCheck = document.createElement('td');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.checked = selected.has(key);
      cb.addEventListener('change', ()=>{
        if(cb.checked) selected.add(key); else selected.delete(key);
      });
      tdCheck.appendChild(cb);

      const tdTime = cell(r.slot_time);
      const tdStatus = cell(isRes ? 'Reserved' : 'Open', isRes ? 'tag green' : 'tag gray');
      const tdProbe  = cell(r.queue_code || '');
      const tdDrv    = cell(r.driver_name || '');
      const tdPlate  = cell(r.license_plate || '');
      const tdVend   = cell(r.vendor_name || '');
      const tdFarm   = cell(r.farm_or_ticket || '');
      const tdQty    = cell(formatQty(r));
      const tdPhone  = cell(r.driver_phone || '');
      const tdFlags  = cell(flagsText(r));

      tr.append(tdCheck, tdTime, tdStatus, tdProbe, tdDrv, tdPlate, tdVend, tdFarm, tdQty, tdPhone, tdFlags);
      tbody.appendChild(tr);
    }
  }

  function cell(txt, cls){ const td=document.createElement('td'); if(cls){const s=document.createElement('span'); s.className=cls; s.textContent=txt; td.appendChild(s);} else {td.textContent=txt;} return td; }
  function formatQty(r){ if(r.est_amount==null) return ''; return `${r.est_amount} ${r.est_unit||''}`.trim(); }
  function flagsText(r){
    const f = [];
    if (r.disabled) f.push('Disabled');
    if (r.is_workin) f.push('Work-in');
    return f.join(', ');
  }

  // --- selection helpers
  $('#checkAll').addEventListener('change', (e)=>{
    const check = e.target.checked;
    const kind = $('#filterKind').value;
    const fromMin = hhmmToMin($('#fromTime').value || '00:00');
    const toMin   = hhmmToMin($('#toTime').value || '23:59');

    for (const r of rows) {
      const tmin = hhmmToMin(r.slot_time);
      if (tmin < fromMin || tmin > toMin) continue;
      const isRes = !!r.reservation_id;
      if (kind === 'open' && isRes) continue;
      if (kind === 'reserved' && !isRes) continue;
      const key = isRes ? `res:${r.reservation_id}` : r.slot_time;
      if (check) selected.add(key); else selected.delete(key);
    }
    render();
  });
  $('#btnSelectAll').addEventListener('click', ()=>{ $('#checkAll').checked=true; $('#checkAll').dispatchEvent(new Event('change')); });
  $('#btnClearSel').addEventListener('click', ()=>{ selected.clear(); $('#checkAll').checked=false; render(); });

  // --- toolbar events
  $('#btnRefresh').addEventListener('click', load);
  $('#site').addEventListener('change', load);
  $('#date').addEventListener('change', load);
  $('#filterKind').addEventListener('change', render);
  $('#fromTime').addEventListener('change', render);
  $('#toTime').addEventListener('change', render);

  // --- mass cancel (reserved ONLY) — prompts for reason and notifies drivers
  $('#btnMassCancel').addEventListener('click', async ()=>{
    const { site_id, date } = ctx();
    const ids = Array.from(selected)
      .filter(k => k.startsWith('res:'))
      .map(k => Number(k.split(':')[1]))
      .filter(Number.isInteger);

    if (!ids.length) return setMsg('Select reserved rows to cancel', true);

    const reason = window.prompt('Enter a reason for cancellation (optional):', '');
    // If user clicks Cancel in the prompt, we stop to avoid accidental sends
    if (reason === null) return;

    try{
      const r = await fetch('/api/slots/mass-cancel', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id, date, reservation_ids: ids, notify: true, reason: (reason||'') })
      });
      const j = await r.json();
      if(!r.ok || j.error) throw new Error(j.error || r.statusText);
      setMsg(`Canceled ${j.canceled || 0} reservation(s). ${j.notified || 0} driver(s) notified.`);
      selected.clear(); $('#checkAll').checked=false;
      await load();
    }catch(e){ setMsg('Mass cancel failed: '+(e?.message||e), true); }
  });

  // --- mass notify (reserved only)
  $('#btnMassNotify').addEventListener('click', async ()=>{
    const { site_id, date } = ctx();
    const ids = Array.from(selected)
      .filter(k => k.startsWith('res:'))
      .map(k => Number(k.split(':')[1]))
      .filter(Number.isInteger);
    const message = $('#notifyText').value.trim();
    if (!ids.length) return setMsg('Select reserved rows to notify', true);
    if (!message) return setMsg('Enter a message to send', true);

    try{
      const r = await fetch('/api/slots/mass-notify', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id, date, reservation_ids: ids, message })
      });
      const j = await r.json();
      if(!r.ok || j.error) throw new Error(j.error || r.statusText);
      setMsg(`Notified ${j.sent || 0} of ${j.targeted || 0}`);
    }catch(e){ setMsg('Mass notify failed: '+(e?.message||e), true); }
  });

  // --- disable / enable selected (works for open or reserved)
  async function toggleDisabled(disable) {
    const { site_id, date } = ctx();
    const slot_times = Array.from(selected).map(k => k.startsWith('res:') ? keyToTime(k) : k).filter(Boolean);
    if (!slot_times.length) return setMsg('Select rows first', true);
    try{
      const r = await fetch('/api/slots/disable', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id, date, slot_times, disable })
      });
      const j = await r.json();
      if(!r.ok || j.error) throw new Error(j.error || r.statusText);
      setMsg(`${disable?'Disabled':'Enabled'} ${j.updated || 0} slot(s)`);
      await load();
    }catch(e){ setMsg('Update failed: '+(e?.message||e), true); }
  }
  $('#btnDisable').addEventListener('click', ()=> toggleDisabled(true));
  $('#btnEnable').addEventListener('click',  ()=> toggleDisabled(false));

  // helpers
  function keyToTime(key){
    if (!key.startsWith('res:')) return key;
    const id = Number(key.split(':')[1]);
    const r = rows.find(x => x.reservation_id === id);
    return r ? r.slot_time : null;
  }
  function ctx(){ return { site_id:+$('#site').value, date:$('#date').value }; }

  // init
  const today = new Date(); $('#date').value = today.toISOString().slice(0,10);
  load();
})();
</script>
</body>
</html>
