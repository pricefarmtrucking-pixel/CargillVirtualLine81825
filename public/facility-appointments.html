<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Facility — Appointments</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin:12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;white-space:nowrap}
    th.sticky{position:sticky;top:0;background:#fff;z-index:1}
    .chip{padding:2px 8px;border-radius:12px;font-size:12px;display:inline-block}
    .chip.open{background:#f2f7ff}
    .chip.reserved{background:#e9f7ef}
    .dim{opacity:.5}
    .right{margin-left:auto}
    input[type="time"]{padding:6px}
    .btn{padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer}
    .btn.primary{background:#2d6cdf;color:#fff;border-color:#2d6cdf}
    .btn.danger{background:#e54;color:#fff;border-color:#e54}
    .btn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="container">
    <h2>Cargill Soybean — Facility</h2>

    <div class="toolbar">
      <label>Site
        <select id="siteSel">
          <option value="1">East (1)</option>
          <option value="2">West (2)</option>
        </select>
      </label>

      <label>Date
        <input type="date" id="dateSel"/>
      </label>

      <button class="btn" id="refreshBtn">Refresh</button>

      <span class="right"></span>

      <label>Filter
        <select id="filterSel">
          <option value="all">All</option>
          <option value="open">Open</option>
          <option value="reserved">Reserved</option>
        </select>
      </label>

      <label>From
        <input type="time" id="fromTime" step="60" value="00:00">
      </label>
      <label>To
        <input type="time" id="toTime" step="60" value="23:59">
      </label>

      <button class="btn" id="clearFilters">Clear</button>
    </div>

    <div class="toolbar">
      <label><input type="checkbox" id="masterChk"/> Select all</label>
      <button class="btn" id="textBtn" disabled>Mass Text</button>
      <button class="btn danger" id="cancelBtn" disabled>Mass Cancel</button>
      <button class="btn" id="hideOpenBtn" disabled>Hide Open Slots</button>
    </div>

    <table id="grid">
      <thead>
        <tr>
          <th class="sticky"><input type="checkbox" id="masterChkTop"/></th>
          <th class="sticky">Time</th>
          <th class="sticky">Driver</th>
          <th class="sticky">Plate</th>
          <th class="sticky">Vendor</th>
          <th class="sticky">Farm/Ticket</th>
          <th class="sticky">Est. Amt</th>
          <th class="sticky">Unit</th>
          <th class="sticky">Phone</th>
          <th class="sticky">Probe Code</th>
          <th class="sticky">Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="dim">* “Probe Code” is the 4‑digit confirmation the driver shows at the probe desk.</p>
  </div>

  <script>
    const siteSel   = document.getElementById('siteSel');
    const dateSel   = document.getElementById('dateSel');
    const refreshBtn= document.getElementById('refreshBtn');
    const filterSel = document.getElementById('filterSel');
    const fromTime  = document.getElementById('fromTime');
    const toTime    = document.getElementById('toTime');
    const clearFilters = document.getElementById('clearFilters');

    const masterChk = document.getElementById('masterChk');
    const masterChkTop = document.getElementById('masterChkTop');
    const textBtn   = document.getElementById('textBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const hideOpenBtn = document.getElementById('hideOpenBtn');
    const gridBody  = document.querySelector('#grid tbody');

    // init date to today (local)
    dateSel.value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);

    let allItems = []; // raw rows from server
    let visible  = []; // filtered rows

    function toMin(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }

    async function load() {
      const url = `/api/appointments?site_id=${siteSel.value}&date=${dateSel.value}`;
      const r = await fetch(url);
      if (!r.ok) { alert('Load failed'); return; }
      const data = await r.json();
      allItems = data.items || [];
      applyFilters();
    }

    function applyFilters() {
      const f = filterSel.value;
      const from = toMin(fromTime.value);
      const to   = toMin(toTime.value);

      visible = allItems.filter(x => {
        const t = toMin(x.slot_time);
        if (t < from || t > to) return false;
        if (f === 'open')     return !x.reservation_id;
        if (f === 'reserved') return !!x.reservation_id;
        return true;
      });

      // sort chronologically (already sorted from API, but re-sort after range filter)
      visible.sort((a,b) => toMin(a.slot_time) - toMin(b.slot_time));
      render();
    }

    function render() {
      gridBody.innerHTML = '';
      for (const row of visible) {
        const tr = document.createElement('tr');
        tr.dataset.slot = row.slot_time;
        tr.dataset.reservationId = row.reservation_id || '';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'rowChk';
        chk.dataset.slot = row.slot_time;
        chk.dataset.reservationId = row.reservation_id || '';
        chk.addEventListener('change', updateBulkButtons);

        tr.appendChild(td(chk));
        tr.appendChild(td(row.slot_time));
        tr.appendChild(td(row.driver_name || '—'));
        tr.appendChild(td(row.license_plate || '—'));
        tr.appendChild(td(row.vendor_name || '—'));
        tr.appendChild(td(row.farm_or_ticket || '—'));
        tr.appendChild(td(row.est_amount ?? '—'));
        tr.appendChild(td(row.est_unit || '—'));
        tr.appendChild(td(row.driver_phone || '—'));
        tr.appendChild(td(row.queue_code || '—'));

        const chip = document.createElement('span');
        chip.className = 'chip ' + (row.reservation_id ? 'reserved' : 'open');
        chip.textContent = row.reservation_id ? 'reserved' : 'open';
        tr.appendChild(td(chip));

        gridBody.appendChild(tr);
      }
      masterChk.checked = false;
      masterChkTop.checked = false;
      updateBulkButtons();
    }

    function td(v) {
      const el = document.createElement('td');
      if (v instanceof Node) el.appendChild(v); else el.textContent = v;
      return el;
    }

    function selected() {
      const chks = Array.from(document.querySelectorAll('.rowChk:checked'));
      const reservation_ids = chks.map(c => c.dataset.reservationId).filter(Boolean).map(Number);
      const open_slots = chks.filter(c => !c.dataset.reservationId).map(c => c.dataset.slot);
      return { reservation_ids, open_slots };
    }

    function updateBulkButtons() {
      const { reservation_ids, open_slots } = selected();
      textBtn.disabled   = reservation_ids.length === 0;
      cancelBtn.disabled = reservation_ids.length === 0;
      hideOpenBtn.disabled = open_slots.length === 0;
    }

    // master checkboxes (top/bottom synced)
    function setAllChecked(v){
      document.querySelectorAll('.rowChk').forEach(c => c.checked = v);
      masterChk.checked = v; masterChkTop.checked = v;
      updateBulkButtons();
    }
    masterChk.addEventListener('change', e => setAllChecked(e.target.checked));
    masterChkTop.addEventListener('change', e => setAllChecked(e.target.checked));

    // Bulk actions
    textBtn.addEventListener('click', async () => {
      const { reservation_ids } = selected();
      const message = prompt('Text to send to selected drivers:');
      if (!message) return;
      const r = await fetch('/api/slots/mass-notify', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id: Number(siteSel.value), date: dateSel.value, reservation_ids, message })
      });
      if (!r.ok) return alert('Failed to send');
      const data = await r.json();
      alert(`Sent ${data.sent}/${data.targeted}`);
    });

    cancelBtn.addEventListener('click', async () => {
      const { reservation_ids } = selected();
      if (!reservation_ids.length) return;
      if (!confirm(`Cancel ${reservation_ids.length} reservation(s)?`)) return;
      const reason = prompt('Optional reason (included in SMS if notify enabled):') || '';
      const notify = confirm('Send cancel SMS to drivers?');
      const r = await fetch('/api/slots/mass-cancel', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id: Number(siteSel.value), date: dateSel.value, reservation_ids, reason, notify })
      });
      if (!r.ok) return alert('Failed to cancel');
      await load();
      alert('Done.');
    });

    hideOpenBtn.addEventListener('click', async () => {
      const { open_slots } = selected();
      if (!open_slots.length) return;
      if (!confirm(`Hide ${open_slots.length} open slot(s) from availability?`)) return;
      const r = await fetch('/api/slots/hide-open', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site_id: Number(siteSel.value), date: dateSel.value, slot_times: open_slots })
      });
      if (!r.ok) return alert('Failed to hide');
      await load();
    });

    // Filters
    [filterSel, fromTime, toTime].forEach(el => el.addEventListener('change', applyFilters));
    clearFilters.addEventListener('click', () => {
      filterSel.value = 'all';
      fromTime.value = '00:00';
      toTime.value   = '23:59';
      applyFilters();
    });

    refreshBtn.addEventListener('click', load);
    siteSel.addEventListener('change', load);
    dateSel.addEventListener('change', load);

    load();
  </script>
</body>
</html>
