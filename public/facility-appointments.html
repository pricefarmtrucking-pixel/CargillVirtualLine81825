<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Facility — Appointments</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#f9f9f9; }
    .container { max-width:1200px; margin:2rem auto; background:#fff; border:1px solid #ddd; border-radius:10px; padding:1.5rem; box-shadow:0 2px 6px rgba(0,0,0,.05); }
    h1 { margin-top:0; font-size:1.4rem; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { padding:.6rem; border-bottom:1px solid #eee; text-align:left; font-size:.9rem; }
    th { background:#f3f3f3; }
    .status-open { color:#0a7a28; font-weight:bold; }
    .status-reserved { color:#0057b7; font-weight:bold; }
    .status-cancelled { color:#b00020; font-weight:bold; }
    .btn { padding:.4rem .7rem; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
    .btn.primary { background:#1e90ff; color:#fff; border:none; }
    .row { display:flex; align-items:center; gap:.6rem; margin-bottom:.8rem; flex-wrap:wrap; }
    select, input { padding:.4rem .6rem; border:1px solid #ccc; border-radius:6px; }
    .error { color:#b00020; margin-top:.5rem; }
    .note { font-size:.8rem; color:#555; margin-top:.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Facility — Appointments</h1>
    <div class="row">
      <a href="index.html" class="btn">Home</a>
      <a href="timeslots-select.html" class="btn">Driver Site</a>
      <label>Site</label>
      <select id="site">
        <option value="east">East</option>
        <option value="west">West</option>
      </select>
      <label>Date</label>
      <input type="date" id="date"/>
      <button id="refresh" class="btn primary">Refresh</button>
      <label><input type="checkbox" id="autoRefresh"/> Auto-refresh (30s)</label>
      <label>Filter</label>
      <select id="filter">
        <option value="all">All</option>
        <option value="open">Open</option>
        <option value="reserved">Reserved</option>
      </select>
      <input type="text" id="search" placeholder="Search name, plate, vendor, code..."/>
    </div>
    <div id="error" class="error"></div>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Driver</th>
          <th>Plate</th>
          <th>Vendor</th>
          <th>Farm/Ticket</th>
          <th>Est. Amt</th>
          <th>Unit</th>
          <th>Phone</th>
          <th>Probe Code</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="11">Loading…</td></tr>
      </tbody>
    </table>
    <div class="note">* "Probe Code" is the 4-digit confirmation used by the probe desk to match the driver to the load.</div>
  </div>

<script>
(function(){
  const apiBase = '';
  const $ = id => document.getElementById(id);
  let timer;

  async function load(){
    clearTimeout(timer);
    const site = $('site').value;
    const date = $('date').value;
    const filter = $('filter').value;
    const search = $('search').value.trim();
    const rows = $('rows');
    const err = $('error');
    err.textContent = '';
    rows.innerHTML = '<tr><td colspan="11">Loading…</td></tr>';

    try{
      const r = await fetch(apiBase+'/api/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ site_id:site, date })
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.error) throw new Error(j.error||r.statusText);

      let list = j.appointments || [];
      if(filter!=='all') list = list.filter(x=>x.status.toLowerCase()===filter);
      if(search){
        const q = search.toLowerCase();
        list = list.filter(x=>
          (x.driver||'').toLowerCase().includes(q) ||
          (x.plate||'').toLowerCase().includes(q) ||
          (x.vendor||'').toLowerCase().includes(q) ||
          (x.queue_code||'').toLowerCase().includes(q)
        );
      }

      if(!list.length){
        rows.innerHTML = '<tr><td colspan="11">No appointments found.</td></tr>';
        return;
      }

      rows.innerHTML = list.map(x=>`
        <tr>
          <td>${x.time||''}</td>
          <td>${x.driver||''}</td>
          <td>${x.plate||''}</td>
          <td>${x.vendor||''}</td>
          <td>${x.farm_ticket||''}</td>
          <td>${x.est_amount||''}</td>
          <td>${x.unit||''}</td>
          <td>${x.phone||''}</td>
          <td>${x.queue_code||'-'}</td>
          <td class="status-${(x.status||'').toLowerCase()}">${x.status||''}</td>
          <td>
            ${x.status==='Open' ? `<button class="btn primary" onclick="assign('${x.id}')">Assign</button>` : `
              <button class="btn" onclick="reassign('${x.id}')">Reassign</button>
              <button class="btn" onclick="cancelRes('${x.id}')">Cancel</button>
            `}
          </td>
        </tr>
      `).join('');

    }catch(e){
      err.textContent = 'Load failed: '+e.message;
      rows.innerHTML = '<tr><td colspan="11">Error loading data.</td></tr>';
    }

    if($('autoRefresh').checked){
      timer = setTimeout(load, 30000);
    }
  }

  window.assign = async function(id){
    alert('Assign flow would POST /api/slots/reserve {slot_id:'+id+'}');
  }
  window.reassign = async function(id){
    alert('Reassign flow would POST /api/slots/reassign {reservation_id:'+id+'}');
  }
  window.cancelRes = async function(id){
    alert('Cancel flow would POST /api/slots/cancel {reservation_id:'+id+'}');
  }

  $('refresh').addEventListener('click', load);
  $('site').addEventListener('change', load);
  $('date').addEventListener('change', load);
  $('filter').addEventListener('change', load);
  $('search').addEventListener('input', load);

  $('date').value = new Date().toISOString().split('T')[0];
  load();
})();
</script>
</body>
</html>
