<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cargill Soybean — Virtual Line</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .container { max-width: 1100px; margin: 5vh auto; padding: 0 1rem; }
    .card { border:1px solid #ddd; border-radius:12px; padding:1.25rem; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.03); }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 1rem; }
    .brand { font-weight: 800; letter-spacing:.2px; }
    .actions a, .actions button { margin-right:.5rem; }
    .button { padding:.6rem 1rem; border:none; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-block; }
    .button.primary { background:#1e90ff; color:#fff; }
    .button.ghost { background:#f7f7f7; color:#222; border:1px solid #ddd; }
    .small { color:#555; font-size:.95rem; }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#f3f3f3; padding:.15rem .35rem; border-radius:6px; border:1px solid #e6e6e6; }
    .callout { padding:.75rem; border:1px dashed #cfe3ff; border-radius:10px; background:#f7fbff; }
    .link { color:#1e90ff; text-decoration:none; }
    .input { width:100%; padding:.7rem .8rem; border:1px solid #ccc; border-radius:10px; }
    .code { font-family: ui-monospace, Menlo, Consolas, monospace; text-align:center; letter-spacing:.2em; }
    #otpMsg { margin-top:.6rem; min-height: 1.2em; }
    .muted { color:#777; font-size:.85rem; margin-top:.25rem; }
    .row { display:flex; gap:.5rem; align-items:center; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">Cargill Soybean — Virtual Line</div>
    <div class="actions">
      <a class="button ghost" href="timeslots-select.html">Choose a Time</a>
      <a class="button primary" href="admin-login.html">Admin</a>
      <a class="button primary" href="probe-login.html">Probe</a>
    </div>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
    <div class="card">
      <h2>Welcome</h2>
      <p class="small">Reserve a dumping time at the East or West plant, then check in on arrival.</p>
      <div class="callout" style="margin-top:.75rem;">
        <strong>Prefer to book by phone?</strong><br/>
        Call the facility at <a class="link" href="tel:(555) 123-4567">(555) 123-4567</a> to book a time over the phone.<br/>
        Alternatively, contact your vendor and ask them to schedule a time on your behalf.
      </div>
      <div class="small" style="margin-top:.75rem;">Need help later? Save our number: <span class="kbd">(555) 123-4567</span></div>
    </div>

    <div class="card">
      <h2>Driver Sign-In</h2>
      <p class="small">Enter your mobile number to receive a one-time code.</p>

      <div>
        <label>Mobile number</label>
        <input id="phone" class="input" placeholder="+1XXXXXXXXXX" autocomplete="tel"/>
        <div class="row" style="margin-top:.6rem;">
          <button id="btnSend" class="button primary" type="button">Send Code</button>
          <button id="btnResend" class="button ghost" type="button" disabled>Resend (60)</button>
        </div>
        <div id="otpMsg" class="small" style="color:#b00020;"></div>
        <div class="muted">Text STOP to opt out. Text START to opt in.</div>
      </div>

      <div id="codeBox" style="margin-top:1rem; display:none;">
        <label>Enter 6-digit code</label>
        <input id="code" maxlength="6" class="input code" inputmode="numeric" placeholder="______" style="margin-top:.4rem; text-align:center;"/>
        <button id="btnVerify" class="button primary" style="margin-top:.6rem;" type="button">Verify & Continue</button>
        <div class="small" style="margin-top:.6rem;">On verify, we’ll unlock booking and check-in features.</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const apiBase = '';
  const $ = id => document.getElementById(id);
  function setMsg(t, ok=false){ const el=$('otpMsg'); el.textContent=t||''; el.style.color = ok?'#0a7a28':'#b00020'; }
  function normalizePhone(p){
    const d = String(p||'').replace(/\D/g,'');
    if (/^\d{10}$/.test(d)) return '+1'+d;
    const m = d.match(/^1?(\d{10})$/); return m?'+1'+m[1]:null;
  }
  function startCooldown(seconds=60){
    const btn = $('btnResend'); btn.disabled = true; let t=seconds; btn.textContent='Resend ('+t+')';
    const iv=setInterval(()=>{ t--; btn.textContent= t>0? 'Resend ('+t+')' : 'Resend'; if(t<=0){clearInterval(iv); btn.disabled=false;}},1000);
  }
  async function sendOrResend(){
    setMsg('', true);
    const phone = normalizePhone($('phone').value.trim());
    if (!phone) return setMsg('Enter a valid 10-digit US number');
    try{
      const r = await fetch(apiBase+'/auth/request-code',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ phone }), credentials:'include' });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.error) return setMsg('Failed: '+(j.error||r.statusText));
      if(j.sms && j.sms.sent===false) return setMsg('SMS error: '+(j.sms.error||j.sms.reason||'unknown'));
      setMsg('Code sent! Check your texts.', true);
      $('codeBox').style.display='block'; $('code').focus(); startCooldown(60);
    }catch(e){ setMsg('Network error: '+(e?.message||e)); }
  }
  function readCode(){ const v=$('code').value.trim(); return /^\d{6}$/.test(v)?v:null; }
  async function verify(){
    const phone = normalizePhone($('phone').value.trim()); const code = readCode();
    if(!phone) return setMsg('Phone missing/invalid');
    if(!code) return setMsg('Enter the 6-digit code');
    try{
      const r = await fetch(apiBase+'/auth/verify',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ phone, code }), credentials:'include' });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.error) return setMsg('Verify failed: '+(j.error||r.statusText));
      setMsg('Verified! Redirecting…', true);
      location.href='timeslots-select.html';
    }catch(e){ setMsg('Network error: '+(e?.message||e)); }
  }
  $('btnSend').addEventListener('click', e=>{e.preventDefault(); sendOrResend();});
  $('btnResend').addEventListener('click', e=>{e.preventDefault(); if(!$('btnResend').disabled) sendOrResend();});
  $('btnVerify').addEventListener('click', e=>{e.preventDefault(); verify();});
  $('code').addEventListener('keydown', e=>{ if(e.key==='Enter') verify(); });
})();
</script>
</body>
</html>
