<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Manage Reservation — Cargill Soybean</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .wrap { max-width: 900px; margin: 5vh auto; padding: 0 16px; }
    .hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .btn { padding:.55rem .9rem; border:1px solid #ccc; background:#f7f7f7; border-radius:10px; cursor:pointer; }
    .btn.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }
    label { display:block; font-size:.9rem; margin:.4rem 0; }
    input, select { width:100%; padding:.6rem .7rem; border:1px solid #ccc; border-radius:10px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:.7rem; }
    .card { border:1px solid #ddd; border-radius:12px; padding:1rem; background:#fff; box-shadow:0 1px 8px rgba(0,0,0,.03); margin-top:1rem; }
    .muted { color:#666; }
    .error { color:#b00020; margin-top:.5rem; }
    .ok { color:#0a7d26; margin-top:.5rem; }
    .row { display:flex; gap:.5rem; align-items:center; }
    .small { font-size:.9rem; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h2 style="margin:0;">Manage Reservation</h2>
    <div class="row">
      <a class="btn" href="index.html">Home</a>
      <a class="btn" href="driver-login.html">Driver Login</a>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label>Probe Code (4 digits)</label>
        <input id="probe" placeholder="1234" maxlength="4" inputmode="numeric"/>
      </div>
      <div>
        <label>Phone (optional, last 10 digits)</label>
        <input id="phone" placeholder="(555) 555‑5555" inputmode="tel"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="lookupBtn" class="btn primary" style="width:100%;">Find My Reservation</button>
      </div>
    </div>
    <div id="lookMsg" class="small muted" style="margin-top:.5rem;"></div>
  </div>

  <div id="results"></div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const api = p=>p;

function normPhone(p){
  const d = String(p||'').replace(/\D/g,'');
  if (/^\d{10}$/.test(d)) return '+1'+d;
  if (/^1\d{10}$/.test(d)) return '+'+d;
  if (/^\+1\d{10}$/.test(d)) return d;
  return null;
}

function cardFor(res){
  const wrap = document.createElement('div');
  wrap.className = 'card';
  wrap.innerHTML = `
    <div class="row" style="justify-content:space-between; margin-bottom:.5rem;">
      <div><strong>${res.date} ${res.slot_time}</strong> — ${res.site_id===1?'EAST':'WEST'}</div>
      <div class="small muted">Probe: ${res.queue_code}</div>
    </div>
    <div class="grid">
      <div><label>Driver Name</label><input data-k="driver_name" value="${res.driver_name||''}"/></div>
      <div><label>Driver Phone</label><input data-k="driver_phone" value="${res.driver_phone||''}"/></div>
      <div><label>License Plate</label><input data-k="license_plate" value="${res.license_plate||''}"/></div>
      <div><label>Vendor</label><input data-k="vendor_name" value="${res.vendor_name||''}"/></div>
      <div><label>Farm/Ticket</label><input data-k="farm_or_ticket" value="${res.farm_or_ticket||''}"/></div>
      <div class="row">
        <div style="flex:1">
          <label>Estimated Amount</label>
          <input data-k="est_amount" type="number" value="${res.est_amount??''}"/>
        </div>
        <div style="flex:1">
          <label>Unit</label>
          <select data-k="est_unit">
            <option ${res.est_unit==='BUSHELS'?'selected':''}>BUSHELS</option>
            <option ${res.est_unit==='TONS'?'selected':''}>TONS</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end; margin-top:.8rem; gap:.5rem;">
      <button class="btn" data-act="cancel">Cancel Reservation</button>
      <button class="btn primary" data-act="save">Save Changes</button>
    </div>
    <div class="small" id="msg-${res.id}" style="margin-top:.5rem;"></div>
  `;
  wrap.querySelector('[data-act="save"]').onclick = ()=>save(res.id, wrap);
  wrap.querySelector('[data-act="cancel"]').onclick = ()=>cancel(res.id, wrap);
  return wrap;
}

async function lookup(){
  $('lookMsg').textContent = 'Searching…';
  const probe = String(($('probe').value||'').trim());
  const phone = normPhone($('phone').value||'');
  if (!/^\d{4}$/.test(probe)) { $('lookMsg').textContent='Enter your 4‑digit probe code.'; return; }

  try{
    const r = await fetch(api('/api/driver/reservation-lookup'),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ probe_code: probe, phone })
    });
    const data = await r.json();
    if (!r.ok || !data.ok) throw new Error(data.error||('HTTP '+r.status));

    const list = data.items||[];
    const el = $('results'); el.innerHTML = '';
    if (!list.length){ $('lookMsg').textContent='No matching reservations found.'; return; }
    $('lookMsg').textContent = `Found ${list.length} reservation${list.length>1?'s':''}.`;
    for (const row of list) el.appendChild(cardFor(row));
  }catch(e){
    $('lookMsg').textContent = e.message || 'Lookup failed.';
  }
}

async function save(id, card){
  const probe = String(($('probe').value||'').trim());
  const phone = normPhone($('phone').value||'');
  const kv = {};
  card.querySelectorAll('[data-k]').forEach(inp=>{
    let v = inp.value;
    if (inp.getAttribute('data-k')==='est_amount') v = v===''?null:Number(v);
    kv[inp.getAttribute('data-k')] = v;
  });
  const m = document.getElementById('msg-'+id);
  m.textContent = 'Saving…'; m.className='small muted';
  try{
    const r = await fetch(api('/api/driver/reservation-update'),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ reservation_id:id, probe_code:probe, phone, ...kv })
    });
    const data = await r.json();
    if (!r.ok || !data.ok) throw new Error(data.error||('HTTP '+r.status));
    m.textContent = 'Saved.'; m.className='small ok';
  }catch(e){ m.textContent = e.message || 'Save failed.'; m.className='small error'; }
}

async function cancel(id, card){
  const probe = String(($('probe').value||'').trim());
  const phone = normPhone($('phone').value||'');
  const m = document.getElementById('msg-'+id);
  if (!confirm('Cancel this reservation?')) return;
  m.textContent='Canceling…'; m.className='small muted';
  try{
    const r = await fetch(api('/api/driver/reservation-cancel'),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ reservation_id:id, probe_code:probe, phone })
    });
    const data = await r.json();
    if (!r.ok || !data.ok) throw new Error(data.error||('HTTP '+r.status));
    m.textContent='Canceled.'; m.className='small ok';
    card.remove();
  }catch(e){ m.textContent = e.message || 'Cancel failed.'; m.className='small error'; }
}

$('lookupBtn').onclick = lookup;
</script>
</body>
</html>
