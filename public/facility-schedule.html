<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Facility — Schedule Builder</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#222; }
    .wrap { max-width: 1100px; margin: 4vh auto; padding: 0 16px; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    input, select { padding:.5rem .6rem; border:1px solid #ccc; border-radius:10px; }
    button { padding:.55rem .9rem; border:1px solid #ccc; background:#f7f7f7; border-radius:10px; cursor:pointer; }
    button.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }
    .note { color:#666; margin-top:.5rem; }
    .ok { color:#0a7a28; }
    .err{ color:#b00020; }
    .grid { margin-top:1rem; display:grid; grid-template-columns: repeat(4, 1fr); gap:.5rem; }
    .slot { padding:.6rem; border:1px solid #e5e5e5; border-radius:10px; text-align:center; background:#fff; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>Cargill Soybean — Facility</h2>

  <div class="row">
    <label>Site
      <select id="site">
        <option value="1">East (1)</option>
        <option value="2">West (2)</option>
      </select>
    </label>
    <label>Date <input id="date" type="date"/></label>
    <label>Open <input id="open" type="time" value="07:00"/></label>
    <label>Close <input id="close" type="time" value="17:00"/></label>
    <label>Loads/day <input id="loads" type="number" value="100" min="1"/></label>
    <label>Work-ins/hr <input id="workins" type="number" value="0" min="0"/></label>

    <button id="btnPreview">Generate Slots</button>
    <button id="btnPublish" class="primary">Publish Schedule</button>
  </div>

  <div id="msg" class="note"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
const $ = id => document.getElementById(id);
const api = path => path;

function toMin(hhmm){const [h,m]=hhmm.split(':').map(Number);return h*60+m;}
function toHHMM(min){const h=String(Math.floor(min/60)).padStart(2,'0');const m=String(min%60).padStart(2,'0');return `${h}:${m}`;}

function preview(){
  const site = +$('site').value;
  const date = $('date').value || new Date().toISOString().slice(0,10);
  const open = $('open').value, close = $('close').value;
  const loads = +$('loads').value;
  const minInt = site===2?6:5;
  const start = toMin(open), end=toMin(close);
  const span=end-start;
  const interval=Math.max(minInt, Math.floor(span/Math.max(1,loads-1)));

  $('grid').innerHTML='';
  for(let i=0;i<loads;i++){
    const t=start+i*interval;
    if(t>=start && t<=end){
      const div=document.createElement('div');
      div.className='slot';
      div.textContent=toHHMM(t);
      $('grid').appendChild(div);
    }
  }
  $('msg').textContent = `Preview: ${$('grid').children.length} slots @ ~${interval} min interval (E:${site===2?6:5} min minimum).`;
}

async function publish(){
  const body = {
    date: $('date').value || new Date().toISOString().slice(0,10),
    open_time: $('open').value,
    close_time: $('close').value,
    loads_target: +$('loads').value,
    workins_per_hour: +$('workins').value
  };
  const site = +$('site').value;

  $('msg').className='note'; $('msg').textContent='Publishing…';
  const r = await fetch(api(`/api/sites/${site}/schedule`),{
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({}));
  if(!r.ok || j.error){
    $('msg').className='note err';
    $('msg').textContent = 'Error: '+(j.error||r.statusText);
    return;
  }
  $('msg').className='note ok';
  $('msg').textContent = `Published. Interval ≈ ${j.interval_min} min. Previous open slots overwritten for that day.`;
}

$('date').value = new Date().toISOString().slice(0,10);
$('btnPreview').onclick = preview;
$('btnPublish').onclick = publish;
preview();
</script>
</body>
</html>
