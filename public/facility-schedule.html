<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facility — Schedule Builder</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color: #111; }
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .toolbar label { font-size: 12px; color: #555; display:block; }
    .toolbar .field { display:flex; flex-direction:column; gap:4px; }
    input[type="text"], input[type="date"], select { padding:8px 10px; border:1px solid #d0d7de; border-radius:8px; font-size:14px; min-width:120px; }
    input.hhmm { width:110px; }
    input:invalid { border-color:#e33; }
    .btn { padding:8px 12px; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer; }
    .btn.primary { background:#1677ff; color:#fff; border-color:#1677ff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .help { font-size:12px; color:#666; margin-top:8px; }
    .error { color:#b00020; margin-top:8px; }
    .ok { color:#0a7d26; margin-top:8px; }
    .grid { margin-top:16px; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    .slot { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; text-align:center; background:#fafafa; }
    .row { margin-top: 18px; display:flex; gap:12px; align-items:center; }
    .title { font-weight:600; font-size:20px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="title">Cargill Soybean — Facility</div>

  <div class="toolbar">
    <div class="field">
      <label>Site</label>
      <select id="site">
        <option value="1">East (1)</option>
        <option value="2">West (2)</option>
      </select>
    </div>

    <div class="field">
      <label>Date</label>
      <input id="date" type="date" />
    </div>

    <div class="field">
      <label>Open (HH:MM)</label>
      <!-- TEXT instead of time wheel -->
      <input id="open" class="hhmm" type="text" inputmode="numeric" placeholder="07:00" autocomplete="off" />
    </div>

    <div class="field">
      <label>Close (HH:MM)</label>
      <!-- TEXT instead of time wheel -->
      <input id="close" class="hhmm" type="text" inputmode="numeric" placeholder="17:00" autocomplete="off" />
    </div>

    <div class="field">
      <label>Loads/day</label>
      <input id="loads" type="text" inputmode="numeric" placeholder="80" />
    </div>

    <div class="field">
      <label>Work-ins/hr</label>
      <input id="workins" type="text" inputmode="numeric" placeholder="0" />
    </div>

    <button id="previewBtn" class="btn" type="button">Generate Slots</button>
    <button id="publishBtn" class="btn primary" type="button">Publish Schedule</button>
  </div>

  <div id="msg" class="help">Minimum interval auto-computed (East≈5m, West≈6m).</div>

  <div id="slots" class="grid" aria-live="polite"></div>

  <script>
    // --- HHMM helpers --------------------------------------------------------
    const HHMM_RE = /^([01]?\d|2[0-3]):[0-5]\d$/;

    function normalizeHHMM(raw) {
      // Accept: "700" "07:00" "7 00" "7-00" "0700" etc. Normalize -> "07:00"
      if (!raw) return '';
      let s = String(raw).trim();

      // Replace non-digits with nothing, then reinject colon
      const digits = s.replace(/\D+/g, '');
      if (digits.length === 4) {
        s = digits.slice(0, 2) + ':' + digits.slice(2);
      } else if (digits.length === 3) {
        // e.g. "700" -> 7:00
        s = digits.slice(0, 1) + ':' + digits.slice(1).padStart(2, '0');
      } else if (digits.length === 1 || digits.length === 2) {
        // treat as hour, add :00
        s = digits + ':00';
      } else if (digits.length === 0) {
        s = '';
      } else {
        // If it already has a colon and matches, keep as-is
        if (HHMM_RE.test(s)) return s;
        // fallback: try first 2 + rest
        s = digits.slice(0,2) + ':' + digits.slice(2,4);
      }

      // zero-pad hour
      const m = s.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return s;
      const hh = String(Math.min(23, parseInt(m[1], 10))).padStart(2,'0');
      const mm = String(Math.min(59, parseInt(m[2], 10))).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function attachHHMM(el) {
      el.addEventListener('blur', () => {
        const v = normalizeHHMM(el.value);
        el.value = v;
        el.setCustomValidity(HHMM_RE.test(v) || v==='' ? '' : 'Enter HH:MM');
      });
      el.addEventListener('input', () => {
        el.setCustomValidity('');
      });
    }

    // --- UI elements ---------------------------------------------------------
    const siteEl = document.getElementById('site');
    const dateEl = document.getElementById('date');
    const openEl = document.getElementById('open');
    const closeEl = document.getElementById('close');
    const loadsEl = document.getElementById('loads');
    const workinsEl = document.getElementById('workins');
    const msgEl = document.getElementById('msg');
    const gridEl = document.getElementById('slots');

    attachHHMM(openEl);
    attachHHMM(closeEl);

    // default date = today (local)
    (function setToday(){
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      dateEl.value = d.toISOString().slice(0,10);
      openEl.value = '07:00';
      closeEl.value = '17:00';
      loadsEl.value = '80';
      workinsEl.value = '0';
    })();

    function showMessage(text, type='help') {
      msgEl.className = type === 'error' ? 'error' : (type === 'ok' ? 'ok' : 'help');
      msgEl.textContent = text;
    }

    function renderSlots(list) {
      gridEl.innerHTML = '';
      for (const s of list) {
        const div = document.createElement('div');
        div.className = 'slot';
        div.textContent = s.slot_time + (s.is_workin ? ' • Work-in' : '');
        gridEl.appendChild(div);
      }
    }

    async function callJSON(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        const msg = data && data.error ? data.error : `HTTP ${r.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function values() {
      const site_id = Number(siteEl.value);
      const date = dateEl.value;
      const open_time = normalizeHHMM(openEl.value);
      const close_time = normalizeHHMM(closeEl.value);
      const loads_target = Number(String(loadsEl.value).replace(/\D+/g,'')) || 0;
      const workins_per_hour = Number(String(workinsEl.value).replace(/\D+/g,'')) || 0;
      return { site_id, date, open_time, close_time, loads_target, workins_per_hour };
    }

    async function preview() {
      try {
        const v = values();
        if (!HHMM_RE.test(v.open_time) || !HHMM_RE.test(v.close_time)) {
          showMessage('Please enter Open/Close in HH:MM, e.g., 07:00 and 17:00', 'error');
          return;
        }
        showMessage('Generating…');
        const res = await callJSON(`/api/sites/${v.site_id}/slots/preview`, v);
        renderSlots(res.items || []);
        showMessage(`Generated ${res.items?.length ?? 0} slots. Interval ≈ ${res.interval_min} min.`);
      } catch (e) {
        showMessage(`Error: ${e.message || e}`, 'error');
      }
    }

    async function publishNow() {
      try {
        const v = values();
        if (!HHMM_RE.test(v.open_time) || !HHMM_RE.test(v.close_time)) {
          showMessage('Please enter Open/Close in HH:MM, e.g., 07:00 and 17:00', 'error');
          return;
        }
        showMessage('Publishing…');
        const res = await callJSON(`/api/sites/${v.site_id}/schedule`, v);
        showMessage(`Published. Interval ≈ ${res.interval_min} min.`, 'ok');
        // Refresh preview after publish
        await preview();
      } catch (e) {
        showMessage(`Error: ${e.message || e}`, 'error');
      }
    }

    document.getElementById('previewBtn').addEventListener('click', preview);
    document.getElementById('publishBtn').addEventListener('click', publishNow);

    // Auto-generate once on load
    preview();
  </script>
</body>
</html>
